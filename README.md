# ParsecSharp

Monadic Parser Combinator Library

## これはなに？

ストリーム、主にテキストに対する構文解析を行う汎用パーサです。  
Haskellの有名なパーサライブラリである`Parsec`をC#上で再現した、関数指向なライブラリです。  
このライブラリは、ストリーム全般に対する基礎パーサ、テキストを対象とした基礎パーサ、パーサを変換・合成できるコンビネータの3種類を提供しています。

## コンセプト
- とにかく自分が書きやすいパーサを作りたかった。
  - 型引数はできる限り書きたくない。
  - 型推論がよろしくやってくれる。
  - インテリセンスとは仲良くする。
- C#で関数指向な環境を実現してみたかった。
  - 状態がないって素晴らしい。
- 覚えたてのモナドの理解を再確認したかった。
  - Wikipediaの記述意味わかんなすぎでしょ。

## よいとこ
- 基本的にモナドベースの関数合成なので、パーサ同士の組み立てが自由自在です。
- 構文の定義をそのままコードに落とし込む感覚で記述できます。
- 内部に状態を持たないので、定義したパーサをどのように組み合わせて利用しても書いたとおりに動きます。
- Linqのクエリ構文を活用して、パーサ同士の組み合わせをシンプルな記述で表現できます。

## だめなとこ
- パフォーマンスに難があります。
- エラーのロギング処理がまだ微妙で、役に立つエラーを吐かないことが多いです。
- 古い環境で動かすと死ぬかもしれません。

## 使い方
using staticで使用する前提の設計になっています。  
基本機能は`using static Parsec.Parser;`の一行で全てincludeされます。  
テキスト処理を行いたいときは、上に加えて`Parsec.Text` static classをusing staticして下さい。  
再帰的な構造解析パーサなど、複雑なものを定義したいときは、`Parsec`名前空間もusingして下さい。  
後は、各パーサを好きに組み合わせてから`Parse()`メソッドを呼ぶだけです。  
具体的なパーサ構築方法はExamplesを見るといいと思います。  
各パーサやコンビネータの使い方や挙動はTestを見るといいと思います。  
ドキュメントは、まだないですが、ドキュメントコメントでちゃんと用意します。。。

## もっと使い方
`Parsec.Internal`名前空間をusingすると、パーサそのものの作成、実装を行うための関数や拡張メソッド一式がincludeされます。  
`Internal`には`IEnumerable<T>`をソースストリームに見立てたインターフェイス実装を用意してあるので、こちらを利用することで様々なソースを利用できます。

## その他詳しいひと向けの話
- `Parsec`と違って、全てのパース失敗はバックトラック処理されます。全てのパーサに`try`が付いているイメージです。
- `Parsec`と比較して、一部の関数は同名でも内容が異なったりします。
  - `Try`メソッドはC#の`try`に寄せて、パース処理とエラーリカバリ処理を行うコンビネータになりました。
  - `notFollowedBy`関数は`Not`メソッドになりました。
- ジェネリックオーバーロードをゴリゴリ使ってるので、テキスト向けのパーサを書く時は型引数は本当に書かないで済みます。
- 内部に状態を持たないとかめっちゃ嘘です。中ではこっそり`List<T>`とか使ってます。焼け石に水のパフォーマンス対策です。。いいんだよ、外部に状態が露出しなければ！
- ソースを読んでみたら再帰祭りだったのでスタックが爆発して死ぬと思った？JITコンパイラのtail-call eliminationを限界まで活用しているので、実はスタックは全くと言っていいほど消費しません。わたしJIT君のこと、信じてるからね……

## やりたいこと
- ドキュメントコメント書く。インテリセンスしたいのにドキュメントコメント無いとかしぬの？
- エラーログ処理がもうちょっとなんとかならないか見てみる。でもバックトラック機構と相性が悪いの……
- サンプルふやす。
- もっと実践的テストをふやしてみる。
- ちゃんと動くようならnugetとかにも投げてみたい。
